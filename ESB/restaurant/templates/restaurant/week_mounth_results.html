{% extends 'restaurant/base.html' %}
{% load mathfilters %}

{% block content %}
  <h2>1</h2>
  {% if report_name %}
    <h2>{{ report_name }}</h2>
    {% if report_type_id == 2 %}
      <form method="get">
        <div class="form-group">
          <label for="year_number">Год:</label>
          <input type="number" id="year_number" name="year" class="form-control" min="2021" max="2050" value="{{ current_year }}" />
        </div>
        <div class="form-group">
          <label for="month_number">Месяц:</label>
          <input type="number" id="month_number" name="month" class="form-control" min="1" max="12" value="{{ current_month }}" />
        </div>
        <button type="submit" class="btn btn-primary">Показать</button>
      </form>
      {% elif report_type_id == 3 %}
      <form method="get">
        <div class="form-group">
          <label for="year_number">Год:</label>
          <input type="number" id="year_number" name="year" class="form-control" min="2021" max="2050" value="{{ current_year }}" />
        </div>
        <div class="form-group">
          <label for="week_number">Неделя:</label>
          <input type="number" id="week_number" name="week" class="form-control" min="1" max="53" value="{{ current_week }}" />
        </div>
        <button type="submit" class="btn btn-primary">Показать</button>
      </form>
    {% endif %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Ресторан</th>
          <th>Факт</th>
          <th>Себестоимость</th>
          <th>Количество чеков</th>
          <th>План</th>
          <th>Отклонение</th>
        </tr>
      </thead>
      <tbody>
        {% for data in report_data %}
        <tr>
          <td>{{ data.department__name }} {{ data.department__city }}</td>
          <td class="revenue">{{ data.revenue }} руб.</td>
          <td>{{ data.cost_price }} руб.</td>
          <td>{{ data.number_of_checks }} шт.</td>
          <td>
            <input type="text" name="fact_value_{{ forloop.counter }}" class="fact-input" value="0" onfocus="if (this.value == '0') {this.value = '';}" onblur="if (this.value == '') {this.value = '0';}" />
          </td>
          <td class="deviation"></td>
        </tr>
        {% endfor %}
        <tr>
          <td>ИТОГ</td>
          <td class="total-revenue"></td>
          <td class="total-cost-price"></td>
          <td class="total-number-of-checks"></td>
        </tr>
      </tbody>
    </table>
  {% else %}
    <p>Не удалось определить тип отчета</p>
  {% endif %}
{% endblock %}
{% block script %}
  <script>
    // функция для рассчета отклонения
    function calculateDeviation(row) {
      const revenue = parseFloat(row.querySelector('.revenue').textContent)
      const factValue = parseFloat(row.querySelector('.fact-input').value)
      const deviation = revenue / factValue - 1 || 0
      row.querySelector('.deviation').textContent = deviation.toFixed(2)
    }
    
    // добавляем обработчик события изменения для всех полей "Факт"
    const factInputs = document.querySelectorAll('.fact-input')
    factInputs.forEach((input) => {
      input.addEventListener('input', () => {
        const row = input.closest('tr')
        calculateDeviation(row)
      })
    })
    
    // функция для суммирования значений в ячейках
    function sumCells(cells) {
      let total = 0
      cells.forEach((cell) => {
        const value = parseFloat(cell.textContent)
        if (!isNaN(value)) {
          total += value
        }
      })
      return total
    }

    // суммируем значения по столбцам и выводим их в соответствующие ячейки
    const revenueCells = document.querySelectorAll('.revenue')
    const totalRevenue = sumCells(revenueCells)
    document.querySelector('.total-revenue').textContent = totalRevenue.toFixed(2) + " руб."

    const costPriceCells = document.querySelectorAll('td:nth-child(3)')
    const totalCostPrice = sumCells(costPriceCells)
    document.querySelector('.total-cost-price').textContent = totalCostPrice.toFixed(2) + " руб."

    const numberOfChecksCells = document.querySelectorAll('td:nth-child(4)')
    const totalNumberOfChecks = sumCells(numberOfChecksCells)
    document.querySelector('.total-number-of-checks').textContent = totalNumberOfChecks + " шт."
  </script>
{% endblock %}

{% block footer %}
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">by ArtiBuk and Gravity_V</p>
    </div>
  </footer>
{% endblock %}
