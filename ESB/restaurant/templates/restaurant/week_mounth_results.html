{% extends 'restaurant/base.html' %}
{% load static %} 
{% block scss %}
  <link href="{% static 'css/Style_report.css' %}" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="container">
  <div class="content">
    <div style="display: flex; align-items: center; flex-direction: column;">
      <div class="block" style="width: fit-content;">
        {% if report_name %}
        <h2>{{ report_name }}</h2>
        {% if report_type_id == 2 %}
        <form method="get" style="display: flex; gap: 20px; align-items:center">
          <div style="display: flex; gap: 20px;">
            <div class="">
              <label for="year_number">Год:</label>
              <input type="number" id="year_number" name="year" class="form-control" min="2022" max="2023" value="{{ current_year }}" />
            </div>
            <div class="">
              <label for="month_number">Месяц:</label>
              <input type="number" id="month_number" name="month" class="form-control" min="1" max="12" value="{{ current_month }}" />
            </div>
          </div>
          <button type="submit" class="buttonR">Показать</button>
        </form>
        {% elif report_type_id == 3 %}
        <form method="get" style="display: flex; gap: 20px; align-items:center">
          <div style="display: flex; gap: 20px;">
            <div class="">
              <label for="year_number">Год:</label>
              <input type="number" id="year_number" name="year" class="form-control" min="2022" max="2023" value="{{ current_year }}" />
            </div>
            <div class="">
              <label for="week_number">Неделя:</label>
              <input type="number" id="week_number" name="week" class="form-control" min="1" max="53" value="{{ current_week }}" />
            </div>
          </div>
          <button type="submit" class="buttonR">Показать</button>
        </form>
        {% endif %}
      </div>
      <div class="tableBox">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Ресторан</th>
            <th>Факт</th>
            <th>Себестоимость</th>
            <th>Количество чеков</th>
            <th>План</th>
            <th>Отклонение</th>
          </tr>
        </thead>
        <tbody>
          {% for data in report_data %}
          <tr>
            <td>{{ data.department__name }} {{ data.department__city }}</td>
            <td class="revenue">{{ data.revenue }} руб.</td>
            <td>{{ data.cost_price }} руб.</td>
            <td>{{ data.number_of_checks }} шт.</td>
              <td>
                <input type="text" name="fact_value_{{ forloop.counter }}" class="fact-input" value="0" onfocus="if (this.value == '0') {this.value = '';}" onblur="if (this.value == '') {this.value = '0';}" pattern="[0-9]+" maxlength="10" /> руб.
              </td>
              <td class="deviation"></td>
            </tr>
            {% endfor %}
            <tr>
              <td>ИТОГ</td>
              <td class="total-revenue"></td>
              <td class="total-cost-price"></td>
              <td class="total-number-of-checks"></td>
              <td class="total-fact_value_"></td>
              <td class="total-deviation"></td>
            </tr>
        </tbody>
      </table>
      </div>
    </div>

    {% else %}
    <p>Не удалось определить тип отчета</p>
    {% endif %}
  </div>
</div>
</div>
  {% endblock %}
  {% block script %}
  <script>
  // функция для рассчета отклонения
  function calculateDeviation(row) {
    const revenue = parseFloat(row.querySelector('.revenue').textContent);
    const factValue = parseFloat(row.querySelector('.fact-input').value);
    let deviation = (revenue / factValue - 1) * 100 || 0;
    deviation = Math.max(-1000, Math.min(1000, deviation)); // Ограничиваем результат в диапазоне от -100 до 100
    const deviationCell = row.querySelector('.deviation');
    deviationCell.textContent = deviation.toFixed(2) + '%';
  
    if (deviation < 0) {
      deviationCell.style.color = 'red'; // Устанавливаем красный цвет текста
    } else if (deviation > 0) {
      deviationCell.style.color = 'green'; // Устанавливаем зеленый цвет текста
    } else {
      deviationCell.style.color = 'white'; // Устанавливаем черный цвет текста
    }
  }

  // добавляем обработчик события ввода для полей "Факт"
  const factInputs = document.querySelectorAll('.fact-input');
  factInputs.forEach((input) => {
    input.addEventListener('input', () => {
      const inputValue = input.value;
      const onlyDigits = inputValue.replace(/\D/g, ''); // удалить все символы, кроме цифр
      input.value = onlyDigits;
      const row = input.closest('tr');
      calculateDeviation(row);
      calculateTotalFactValue();
      calculateTotalDeviation();
    });
  });

  // функция для суммирования значений в ячейках
  function sumCells(cells) {
    let total = 0;
    cells.forEach((cell) => {
      const value = parseFloat(cell.textContent);
      if (!isNaN(value)) {
        total += value;
      }
    });
    return total;
  }

  // функция для обновления значения total-fact_value_
  function calculateTotalFactValue() {
    const factValueInputs = document.querySelectorAll('.fact-input');
    let totalFactValue = 0;
    factValueInputs.forEach((input) => {
      const value = parseFloat(input.value);
      if (!isNaN(value)) {
        totalFactValue += value;
      }
    });
    document.querySelector('.total-fact_value_').textContent = totalFactValue.toFixed(2) + " руб.";
  }

  // функция для обновления значения total-deviation
  function calculateTotalDeviation() {
    const deviationCells = document.querySelectorAll('.deviation');
    let totalDeviation = 0;
    let numberOfCells = 0;
    deviationCells.forEach((cell) => {
      const value = parseFloat(cell.textContent);
      if (!isNaN(value)) {
        totalDeviation += value;
        numberOfCells++;
      }
    });
    totalDeviation = totalDeviation / numberOfCells;
    document.querySelector('.total-deviation').textContent = totalDeviation.toFixed(2) + "%";
  }
  
    // функция для обновления общих значений (total-cost-price, total-number-of-checks и total-revenue)
    function calculateTotals() {
      const revenueCells = document.querySelectorAll('.revenue');
      const totalRevenue = sumCells(revenueCells);
      document.querySelector('.total-revenue').textContent = totalRevenue.toFixed(2) + " руб.";
  
      const costPriceCells = document.querySelectorAll('td:nth-child(3)');
      const totalCostPrice = sumCells(costPriceCells);
      document.querySelector('.total-cost-price').textContent = totalCostPrice.toFixed(2) + " руб.";
  
      const numberOfChecksCells = document.querySelectorAll('td:nth-child(4)');
      const totalNumberOfChecks = sumCells(numberOfChecksCells);
      document.querySelector('.total-number-of-checks').textContent = totalNumberOfChecks + " шт.";
    }
  
    // вызываем функцию для расчета и обновления общих значений
    calculateTotals();
  
  </script>
  {% endblock %}
  
{% block footer %}
  <footer>
      <p class="">by ArtiBuk</p>
  </footer>
{% endblock %}
