{% extends 'restaurant/base.html' %}
{% load static %} 
{% block scss %}
  <link href="{% static 'css/Style_report.css' %}" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="container">
  <div class="content">
    <div style="display: flex; align-items: center; flex-direction: column;">
      <div class="block" style="width: fit-content;">
        {% if report_name %}
        <h2>{{ report_name }}</h2>
        {% if report_type_id == 3 %}
        <form method="get" style="display: flex; gap: 20px; align-items:center">
          <div style="display: flex; gap: 20px;">
            <div class="">
              <label for="year_number">Год:</label>
              <input type="number" id="year_number" name="year" class="form-control" min="2022" max="2023" value="{{ current_year }}" />
            </div>
            <div class="">
              <label for="week_number">Неделя:</label>
              <input type="number" id="week_number" name="week" class="form-control" min="1" max="53" value="{{ current_week }}" />
            </div>
          </div>
          <div style="display: flex; gap: 20px;">
            <div class="">
              <label for="year_number">Год сравнения:</label>
              <input type="number" id="year_number" name="compare_year" class="form-control" min="2022" max="2023" value="{{ current_year }}" />
            </div>
            <div class="">
              <label for="week_number">Неделя сравнения:</label>
              <input type="number" id="week_number" name="compare_week" class="form-control" min="1" max="53" value="{{ current_week }}" />
            </div>
          </div>
          <button type="submit" class="buttonR">Показать</button>
        </form>
        {% endif %}
      </div>
      <div class="tableBox">
        <table class="table table-striped">
          <thead>
            <tr>
              <th colspan="2">Дней в месяце</th>
              <th>Количество дней в месяце</th>
              <th colspan="7">Отработано дней</th>
              <th>Прошло дней с начала месяца</th>
            </tr>
            <tr>
              <th colspan="2">Направление</th>
              <th colspan="6"></th>
              <th>Сколько дней от начала месяца</th>
              <th>Количество дней от начала месяца</th>
            </tr>
            <tr>
              <th colspan="1">Категории и название ресторанов</th>
              <th>Выручка за выбранную неделю (руб.)</th>
              <th>Средня выручка за прошлый месяц (руб.)</th>
              <th>Выручка/Среднее (%)</th>
              <th>План (руб.)</th>
              <th>Выручка/Бюджет (%)</th>
              <th>Выручка за 2022 (руб.)</th>
              <th>Выручка/Выручка за 2022 (%)</th>
              <th>Выручка с 1 числа по конец выбранной недели(руб.)</th>
              <th>План(руб.)</th>
              <th>Выручка/План(%)</th>
              <th>Выручка за 2022(тот же период)(руб.)</th>
              <th>Выручка/Выручка за 2022(%)</th>
              <th>Бюджет "месяц в котором выбранная неделя"</th>
              <th>Выполнение (%)</th>
            </tr>
          </thead>
          
          <tbody>
            {% for data in report_data %}
            <tr>
              <td class="categories_names_of_restaurants">{{ data.department__name }} {{ data.department__city }}</td>
              <td class="revenue_for_the_selected_week">{{ data.revenue_selected_week }}</td>
              <td class="average_revenue_last_month">{{ data.compare_revenue }}</td>
              <td class="revenue_average">%</td>
              <td class="plan_1">руб</td>
              <td class="revenue_budget">%</td>
              <td class="revenue_for_2022">{{ data.revenue_for_last_year }}</td>
              <td class="revenue_revenue_for_2022">%</td>
              <td class="revenue_from">{{ data.revenue_from }}</td>
              <td class="plan_2">руб</td>
              <td class="revenue_plan_2">%</td>
              <td class="revenue_for_2022_same_period">{{ data.revenue_for_last_year_same_period }}</td>
              <td class="revenue_2_revenue_for_2022">%</td>
              <td>
                <input type="text" name="budget{{ forloop.counter }}" class="budget" value="0" onfocus="if (this.value == '0') {this.value = '';}" onblur="if (this.value == '') {this.value = '0';}" pattern="[0-9]+" maxlength="10" /> 
              </td>
              <td class="performance">%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <p>Не удалось определить тип отчета</p>
    {% endif %}
  </div>
</div>
</div>
  {% endblock %}
  {% comment %} {% block script %}
  <script>
  // функция для рассчета отклонения
  function calculateDeviation(row) {
    const revenue = parseFloat(row.querySelector('.revenue').textContent);
    const factValue = parseFloat(row.querySelector('.fact-input').value);
    let deviation = (revenue / factValue - 1) * 100 || 0;
    deviation = Math.max(-100, Math.min(100, deviation)); // Ограничиваем результат в диапазоне от -100 до 100
    const deviationCell = row.querySelector('.deviation');
    deviationCell.textContent = deviation.toFixed(2) + '%';
  
    if (deviation < 0) {
      deviationCell.style.color = 'red'; // Устанавливаем красный цвет текста
    } else if (deviation > 0) {
      deviationCell.style.color = 'green'; // Устанавливаем зеленый цвет текста
    } else {
      deviationCell.style.color = 'white'; // Устанавливаем черный цвет текста
    }
  }

  // добавляем обработчик события ввода для полей "Факт"
  const factInputs = document.querySelectorAll('.fact-input');
  factInputs.forEach((input) => {
    input.addEventListener('input', () => {
      const inputValue = input.value;
      const onlyDigits = inputValue.replace(/\D/g, ''); // удалить все символы, кроме цифр
      input.value = onlyDigits;
      const row = input.closest('tr');
      calculateDeviation(row);
      calculateTotalFactValue();
      calculateTotalDeviation();
    });
  });

  // функция для суммирования значений в ячейках
  function sumCells(cells) {
    let total = 0;
    cells.forEach((cell) => {
      const value = parseFloat(cell.textContent);
      if (!isNaN(value)) {
        total += value;
      }
    });
    return total;
  }

  // функция для обновления значения total-fact_value_
  function calculateTotalFactValue() {
    const factValueInputs = document.querySelectorAll('.fact-input');
    let totalFactValue = 0;
    factValueInputs.forEach((input) => {
      const value = parseFloat(input.value);
      if (!isNaN(value)) {
        totalFactValue += value;
      }
    });
    document.querySelector('.total-fact_value_').textContent = totalFactValue.toFixed(2) + " руб.";
  }

  // функция для обновления значения total-deviation
  function calculateTotalDeviation() {
    const deviationCells = document.querySelectorAll('.deviation');
    let totalDeviation = 0;
    let numberOfCells = 0;
    deviationCells.forEach((cell) => {
      const value = parseFloat(cell.textContent);
      if (!isNaN(value)) {
        totalDeviation += value;
        numberOfCells++;
      }
    });
    totalDeviation = totalDeviation / numberOfCells;
    document.querySelector('.total-deviation').textContent = totalDeviation.toFixed(2) + "%";
  }
  
    // функция для обновления общих значений (total-cost-price, total-number-of-checks и total-revenue)
    function calculateTotals() {
      const revenueCells = document.querySelectorAll('.revenue');
      const totalRevenue = sumCells(revenueCells);
      document.querySelector('.total-revenue').textContent = totalRevenue.toFixed(2) + " руб.";
  
      const costPriceCells = document.querySelectorAll('td:nth-child(3)');
      const totalCostPrice = sumCells(costPriceCells);
      document.querySelector('.total-cost-price').textContent = totalCostPrice.toFixed(2) + " руб.";
  
      const numberOfChecksCells = document.querySelectorAll('td:nth-child(4)');
      const totalNumberOfChecks = sumCells(numberOfChecksCells);
      document.querySelector('.total-number-of-checks').textContent = totalNumberOfChecks + " шт.";
    }
  
    // вызываем функцию для расчета и обновления общих значений
    calculateTotals();
  
  </script>
  {% endblock %} {% endcomment %}
  
{% block footer %}
  <footer>
      <p class="">by ArtiBuk</p>
  </footer>
{% endblock %}
